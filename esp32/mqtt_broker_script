#!/bin/bash
# Mosquitto MQTT Broker Setup for Ubuntu/Debian VPS
# Run as root: sudo bash setup_mosquitto.sh

set -e

echo "========================================="
echo "Mosquitto MQTT Broker Setup"
echo "========================================="

# Update system
apt update
apt upgrade -y

# Install Mosquitto and certbot
apt install -y mosquitto mosquitto-clients certbot

# Stop mosquitto to configure
systemctl stop mosquitto

# Create password file directory
mkdir -p /etc/mosquitto/passwd

# Create config directory for custom settings
mkdir -p /etc/mosquitto/conf.d

echo ""
echo "Creating Mosquitto configuration..."

# Main configuration
cat > /etc/mosquitto/conf.d/default.conf << 'EOF'
# Listener for secure connections (TLS)
listener 8883
certfile /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem
cafile /etc/letsencrypt/live/YOUR_DOMAIN/chain.pem
keyfile /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem

# Require username/password
allow_anonymous false
password_file /etc/mosquitto/passwd/passwords

# Persistence
persistence true
persistence_location /var/lib/mosquitto/

# Logging
log_dest file /var/log/mosquitto/mosquitto.log
log_type all
log_timestamp true

# Connection limits
max_connections 1000
max_queued_messages 1000

# Optional: WebSocket support (for web dashboards)
listener 9001
protocol websockets
certfile /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem
cafile /etc/letsencrypt/live/YOUR_DOMAIN/chain.pem
keyfile /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem
EOF

echo ""
echo "========================================="
echo "IMPORTANT: SSL Certificate Setup"
echo "========================================="
echo ""
echo "1. Point your domain (e.g., mqtt.yourcompany.com) to this server's IP"
echo "2. Wait for DNS to propagate (5-30 minutes)"
echo "3. Run: certbot certonly --standalone -d mqtt.yourcompany.com"
echo "4. Update /etc/mosquitto/conf.d/default.conf with your domain"
echo "5. Create MQTT users (see below)"
echo ""

echo "========================================="
echo "Creating MQTT Users"
echo "========================================="
echo ""

# Function to create user
create_user() {
    read -p "Enter username: " username
    mosquitto_passwd -c /etc/mosquitto/passwd/passwords "$username"
    echo "User $username created!"
}

# Create first user
echo "Let's create your first MQTT user (for devices):"
create_user

echo ""
read -p "Create another user (e.g., for admin/API)? (y/n): " create_another

if [ "$create_another" = "y" ]; then
    mosquitto_passwd /etc/mosquitto/passwd/passwords
fi

# Set correct permissions
chown -R mosquitto:mosquitto /etc/mosquitto/passwd
chmod 600 /etc/mosquitto/passwd/passwords

# Setup automatic cert renewal
cat > /etc/letsencrypt/renewal-hooks/post/restart-mosquitto.sh << 'EOF'
#!/bin/bash
systemctl restart mosquitto
EOF
chmod +x /etc/letsencrypt/renewal-hooks/post/restart-mosquitto.sh

# Enable and start Mosquitto
systemctl enable mosquitto
systemctl start mosquitto

# Setup firewall (if using ufw)
if command -v ufw &> /dev/null; then
    echo ""
    echo "Configuring firewall..."
    ufw allow 8883/tcp comment 'MQTT TLS'
    ufw allow 9001/tcp comment 'MQTT WebSockets'
    ufw allow 80/tcp comment 'HTTP for Certbot'
    ufw allow 443/tcp comment 'HTTPS'
    ufw --force enable
fi

echo ""
echo "========================================="
echo "Setup Complete!"
echo "========================================="
echo ""
echo "Next steps:"
echo "1. Get SSL certificate:"
echo "   certbot certonly --standalone -d mqtt.yourcompany.com"
echo ""
echo "2. Update domain in config:"
echo "   nano /etc/mosquitto/conf.d/default.conf"
echo "   (Replace YOUR_DOMAIN with mqtt.yourcompany.com)"
echo ""
echo "3. Restart Mosquitto:"
echo "   systemctl restart mosquitto"
echo ""
echo "4. Test connection:"
echo "   mosquitto_pub -h mqtt.yourcompany.com -p 8883 -t test -m 'hello' -u USERNAME -P PASSWORD"
echo ""
echo "5. View logs:"
echo "   tail -f /var/log/mosquitto/mosquitto.log"
echo ""
echo "6. Add more users:"
echo "   mosquitto_passwd /etc/mosquitto/passwd/passwords USERNAME"
echo ""
echo "========================================="
echo "Security Tips:"
echo "========================================="
echo "- Use unique passwords for each device type"
echo "- Consider ACL (Access Control Lists) for topic restrictions"
echo "- Monitor logs regularly"
echo "- Keep system updated"
echo ""
